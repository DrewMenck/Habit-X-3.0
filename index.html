<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>HabitXFullfix</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div id="offlineBanner" class="banner" aria-live="polite" role="status" hidden>âœ… Offline Ready â€” you can Add to Home Screen now</div>

  <header class="appbar">
    <h1>HabitXFullfix</h1>
    <button id="installBtn" class="ghost" aria-label="Install">âž•</button>
  </header>

  <main>
    <section class="panel">
      <div class="row wrap">
        <select id="habitSelect" aria-label="Select habit"></select>
        <button id="addHabitBtn" class="primary">Add Habit</button>
        <button id="bulkAddBtn">Add Multiple</button>
      </div>
      <div class="stats">
        <div class="stat"><span id="currentStreak">0</span><label>Current Streak</label></div>
        <div class="stat"><span id="longestStreak">0</span><label>Longest Streak</label></div>
        <div class="stat"><span id="completionPct">0%</span><label>30d %</label></div>
        <div class="stat"><span id="habitScore">0</span><label>Score</label></div>
      </div>
    </section>

    <section class="panel">
      <div class="row cal-header">
        <button id="prevMonth" class="ghost" aria-label="Previous month">â—€</button>
        <h2 id="monthLabel"></h2>
        <button id="nextMonth" class="ghost" aria-label="Next month">â–¶</button>
      </div>
      <div class="weekday-row">
        <span>Sun</span><span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span>
      </div>
      <div id="calendarGrid" class="calendar" role="grid" aria-label="Calendar"></div>
    </section>

    <section class="panel">
      <div class="row wrap">
        <button id="exportBtn">Export Data</button>
        <label class="import">
          <input type="file" id="importFile" accept=".json" hidden>
          <span class="button">Import Data</span>
        </label>
        <button id="deleteHabitBtn" class="danger">Delete Habit</button>
      </div>
      <p class="fine">Tip: Tap a day to toggle completion. Data is saved locally (IndexedDB) and survives refresh/restarts.</p>
    </section>
  </main>

  <!-- Single Add -->
  <dialog id="habitDialog">
    <form id="habitForm">
      <h3>New Habit</h3>
      <label>Name<input id="habitName" required maxlength="40" placeholder="e.g., Read 20 minutes"></label>
      <label>Emoji / Color
        <div class="row">
          <input id="habitEmoji" maxlength="2" placeholder="ðŸ“š">
          <input id="habitColor" type="color" value="#ff9800" aria-label="Habit color">
        </div>
      </label>
      <menu>
        <button type="button" value="cancel" onclick="document.getElementById('habitDialog').close()">Cancel</button>
        <button type="submit" value="ok" class="primary">Create</button>
      </menu>
    </form>
  </dialog>

  <!-- Bulk Add -->
  <dialog id="bulkDialog">
    <form id="bulkForm">
      <h3>Add Multiple Habits</h3>
      <p class="fine">One per line. Optional emoji and hex color (e.g., <code>ðŸ“– Read 20m #ff9800</code>).</p>
      <textarea id="bulkText" rows="8" placeholder="ðŸ“– Read 20m #ff9800
Workout
ðŸ’§ Hydrate #3fa9f5"></textarea>
      <menu>
        <button type="button" onclick="document.getElementById('bulkDialog').close()">Cancel</button>
        <button type="submit" class="primary">Create All</button>
      </menu>
    </form>
  </dialog>

  <script src="app.js"></script>
  <script>
    // Robust offline-ready detection + fallback verification
    (function(){
      const banner = document.getElementById('offlineBanner');
      function showBanner(){ if(banner && banner.hasAttribute('hidden')) banner.removeAttribute('hidden'); }
      // Listen for SW messages
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.addEventListener('message', (e)=>{
          if (e.data && (e.data.type==='offline-ready' || e.data==='offline-ready')) showBanner();
        });
        // If SW is already controlling, verify cache contents
        navigator.serviceWorker.ready.then(()=>verifyCache().then(ok=>ok && showBanner()));
        // Fallback timer: try verify after 30s
        setTimeout(()=>verifyCache().then(ok=>ok && showBanner()), 30000);
      }
      async function verifyCache(){
        if (!('caches' in window)) return false;
        try{
          const cache = await caches.open('habitxfullfix-v2');
          const needed = [
            './','./index.html','./styles.css','./app.js','./manifest.webmanifest',
            './icons/icon-192.png','./icons/icon-512.png','./apple-touch-icon.png'
          ];
          const checks = await Promise.all(needed.map(u=>cache.match(u)));
          return checks.every(Boolean);
        }catch(e){ return false; }
      }
    })();
  </script>
</body>
</html>
